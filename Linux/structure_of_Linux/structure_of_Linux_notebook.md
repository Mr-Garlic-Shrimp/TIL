# Linuxの仕組みを学習

参考：[【試して理解】Linuxのしくみ　武内 覚 著](https://www.amazon.co.jp/%EF%BC%BB%E8%A9%A6%E3%81%97%E3%81%A6%E7%90%86%E8%A7%A3%EF%BC%BDLinux%E3%81%AE%E3%81%97%E3%81%8F%E3%81%BF-%E2%80%95%E5%AE%9F%E9%A8%93%E3%81%A8%E5%9B%B3%E8%A7%A3%E3%81%A7%E5%AD%A6%E3%81%B6OS%E3%80%81%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%80%81%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E5%9F%BA%E7%A4%8E%E7%9F%A5%E8%AD%98%E3%80%90%E5%A2%97%E8%A3%9C%E6%94%B9%E8%A8%82%E7%89%88%E3%80%91-%E6%AD%A6%E5%86%85-%E8%A6%9A/dp/429713148X/ref=asc_df_429713148X/?tag=jpgo-22&linkCode=df0&hvadid=588889454778&hvpos=&hvnetw=g&hvrand=16977626951123336&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=1009298&hvtargid=pla-1776418963434&psc=1&mcid=70ca5394a2c538a1b5826d5845109e09&th=1&psc=1)

## カーネル
* カーネルの主な役割は下記。カーネルはシステム内のすべてのプロセスが共有するリソースを一元管理して、システム上で動作するプロセスに配分しているといえる。
  * プロセス生成、削除
  * メモリ確保、解放
  * 通信処理
  * ファイルシステム操作
  * デバイス操作
* Linuxマシンの電源を入れるとファームウェアやブートローダが動いた後にカーネルが起動する。
  * カーネルが起動した後、その他のプログラムが起動されていく。
    * プログラムとはコンピュータ上で動作する一連の命令、およびデータをひとまとめにしたものであり、カーネルもプログラムの一種である。

## プロセス
* カーネル起動後にメモリにロードされて動作中のプログラムのことをプロセスという。
* 


## CPU
* 一般にCPUにはカーネルモードとユーザモードの2つの動作モードがある。
  * カーネルモード
    * カーネルのみがこのモードで動作し、デバイス等のリソースへのアクセスが許可される
  * ユーザモード
    * カーネル以外のプロセスが動作するモード。リソースへのアクセスは許可されていないので、ユーザプロセスはカーネルに依頼して、リソースへ間接的にアクセスする。
    * このカーネルに処理を依頼することをシステムコールという。
    * ユーザモードで動作するプロセスがシステムコールを発行するとCPUで”例外”イベントが発生し、CPUのモードがユーザモードからカーネルモードに遷移する。その後、依頼内容に応じたカーネルの処理が動く。処理が終わると、再びユーザモードに戻って元のプロセスの動作を継続する。

* 論理CPU
  * カーネルがCPUとして認識する単位を表す。  
  CPUが1コアなら論理CPUは1つ、マルチコアならばコア数分CPUとして認識される。  
  また、SMTを有効にしているならばスレッド/1コア×全コアが論理CPUになる。（場合によるかも）  
  例）　1CPU、6コア、2スレッドの場合は1CPU×4コア×2スレッド/コア = 論理CPU12個
  * 論理CPU数やコア数、スレッド数は"lscpu"コマンドから分かる。
  * 論理CPUが実行している命令の割合はsar(system activity report)コマンドから分かる。  
  下記のようにsarを実行することで任意の論理CPUについて、  
  どのような種類の処理を実行していたのかが分かる。
    ```
    sar -P 論理CPU番号 取得間隔 取得回数
    ```  
    
    ```
    ### sar取得結果 ###
    $ sar -P 0 1 3
    Linux 5.15.133.1-microsoft-standard-WSL2 (DESKTOP-9GHER3P)      11/19/2023      _x86_64_        (12 CPU)
    01:35:52 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
    01:35:53 PM       0      0.00      0.00      1.98      0.00      0.00     98.02
    01:35:54 PM       0      0.96      0.00      4.81      0.00      0.00     94.23
    01:35:55 PM       0      0.00      0.00      1.98      0.00      0.00     98.02
    Average:          0      0.33      0.00      2.94      0.00      0.00     96.73
    ```

    ユーザモードでプロセスを実行していた時間の割合は%userと%niceの合計である。  
    %systemはカーネルがシステムコールを処理していた時間の割合を示す。  
    %idleは何もしていないアイドル状態だった割合を示す。


* ★性能観点メモ
  * プログラムの処理性能観点でいえば、極力システムコールの発行回数を減らすべき。
  * プロセスがどんなシステムコールを発行するかはstraceコマンドで確認できる。
    ```
    strace -o 出力先 プログラムのパス
    ```
    straceの出力は１行１行が１システムコールに対応している。  
    また、-Tオプションをつけることで各システムコールにかかった時間を確認可能。

## システムコール
